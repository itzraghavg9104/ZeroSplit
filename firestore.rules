rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is the document owner
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Helper function to check if user is a member of the group
    function isGroupMember(groupId) {
      return request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.members;
    }
    
    // Helper function to check if user is the group owner
    function isGroupOwner(groupId) {
      // Ensure groupId is not null before checking
      return groupId != null && request.auth.uid == get(/databases/$(database)/documents/groups/$(groupId)).data.createdBy;
    }
    
    // ==================== USERS ====================
    match /users/{userId} {
      // Users can read their own profile
      allow read: if isAuthenticated() && isOwner(userId);
      
      // Users can read other users' basic info (for group member display)
      allow read: if isAuthenticated();
      
      // Users can create their own profile
      allow create: if isAuthenticated() && isOwner(userId);
      
      // Users can update their own profile
      allow update: if isAuthenticated() && isOwner(userId);
      
      // Users cannot delete their profile (for data integrity)
      allow delete: if false;
    }
    
    // ==================== GROUPS ====================
    match /groups/{groupId} {
      // Allow any authenticated user to read groups (needed for joining via code)
      allow read: if isAuthenticated();
      
      // Any authenticated user can create a group
      allow create: if isAuthenticated() 
        && request.auth.uid in request.resource.data.members
        && request.auth.uid == request.resource.data.createdBy;
      
      // Allow any authenticated user to update (needed for joining)
      // Ideally restrict to only adding self to members, but this is sufficient for MVP
      allow update: if isAuthenticated();
      
      // Only group creator can delete the group
      allow delete: if isAuthenticated() && request.auth.uid == resource.data.createdBy;
    }
    
    // ==================== EXPENSES ====================
    match /expenses/{expenseId} {
      // Group members can read expenses
      allow read: if isAuthenticated() && isGroupMember(resource.data.groupId);
      
      // Group members can create expenses
      allow create: if isAuthenticated() 
        && isGroupMember(request.resource.data.groupId)
        && request.auth.uid == request.resource.data.createdBy;
      
      // Expense creator or group members can update
      allow update: if isAuthenticated() && isGroupMember(resource.data.groupId);
      
      // Only expense creator OR group owner can delete
      allow delete: if isAuthenticated() && (
        request.auth.uid == resource.data.createdBy || isGroupOwner(resource.data.groupId)
      );
    }
    
    // ==================== SETTLEMENTS ====================
    match /settlements/{settlementId} {
      // Group members can read settlements
      allow read: if isAuthenticated() && isGroupMember(resource.data.groupId);
      
      // Group members can create settlements
      allow create: if isAuthenticated() 
        && isGroupMember(request.resource.data.groupId)
        && (request.auth.uid == request.resource.data.fromUser 
            || request.auth.uid == request.resource.data.toUser);
      
      // Involved parties can update settlement status
      allow update: if isAuthenticated() 
        && (request.auth.uid == resource.data.fromUser 
            || request.auth.uid == resource.data.toUser);
      
      // Only creator or group owner can delete
      allow delete: if isAuthenticated() && (
        request.auth.uid == resource.data.createdBy || isGroupOwner(resource.data.groupId)
      );
    }
    
    // ==================== ACTIVITIES ====================
    match /activities/{activityId} {
      // Users can read activities they're involved in OR if it belongs to their group
      allow read: if isAuthenticated() 
        && (request.auth.uid == resource.data.userId
            || (resource.data.involvedUsers != null && request.auth.uid in resource.data.involvedUsers)
            || (resource.data.groupId != null && isGroupMember(resource.data.groupId)));
      
      // System creates activities (via server or triggered by other writes)
      allow create: if isAuthenticated();
      
      // Group owner can delete activities (for cleanup)
      allow delete: if isAuthenticated() && isGroupOwner(resource.data.groupId);
      
      // No updates on activity logs
      allow update: if false;
    }
    
    // ==================== INVITATIONS ====================
    match /invites/{invitationId} {
      // Anyone authenticated can read invitations sent to them OR if they are a group member
      allow read: if isAuthenticated() 
        && (request.auth.uid == resource.data.toUserId
            || request.auth.uid == resource.data.invitedBy
            || isGroupMember(resource.data.groupId));
      
      // Group members can create invitations
      allow create: if isAuthenticated();
      
      // Invited user can update (accept/decline)
      allow update: if isAuthenticated() 
        && (request.auth.uid == resource.data.toUserId);
      
      // Inviter, Invited User, or Group Owner can delete invitation
      allow delete: if isAuthenticated() 
        && (request.auth.uid == resource.data.invitedBy
            || request.auth.uid == resource.data.toUserId
            || isGroupOwner(resource.data.groupId));
    }
  }
}
